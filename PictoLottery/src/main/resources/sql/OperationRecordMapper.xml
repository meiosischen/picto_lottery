<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.picto.dao.OperationRecordDao">
    <sql id="queryOperationRecordColumn">
        select ID AS id,
        openid AS openid,
        merchant_id AS merchantId,
        serial_number AS serialNumber,
        type AS type,
        operation_time AS operationTime,
        create_time AS createTime
        from operation_record
    </sql>

    <select id="queryMerchantById" resultType="com.picto.entity.OperationRecord">
        <include refid="queryOperationRecordColumn" />
        where openid = #{openid} and type = #{type}
    </select>

    <select id="queryOperationRecordsToday" resultType="com.picto.entity.OperationRecord">
        <include refid="queryOperationRecordColumn" />
        where merchant_id = #{merchantId} and openid = #{openid} and type = #{type} and operation_time &gt;= #{today}
    </select>

    <select id="queryLatestOperToday" resultType="com.picto.entity.OperationRecord">
        <include refid="queryOperationRecordColumn" />
        where openid = #{openid} and type = #{type} and operation_time &gt;= #{today}
        order by operation_time desc limit 1
    </select>
    
    <select id="queryLatestOperTodayByMerchant" resultType="com.picto.entity.OperationRecord">
        <include refid="queryOperationRecordColumn" />
        where merchant_id = #{merchantId} and openid = #{openid} and type = #{type} and operation_time &gt;= #{today}
        order by operation_time desc limit 1
    </select>

    <insert id="addOperationRecord" parameterType="com.picto.entity.OperationRecord">        
        insert into operation_record(openid, merchant_id,
          <if test="serialNumber != null">
            serial_number,
          </if>
        type, operation_time, create_time)
        values(#{openid}, #{merchantId},
          <if test="serialNumber != null">
              #{serialNumber},
          </if>
        #{type}, #{operationTime}, #{createTime})
        <selectKey resultType="int" keyProperty="id" order="AFTER" >
	      select LAST_INSERT_ID() AS id
	    </selectKey>
    </insert>

    <update id="updateSerialNumber">
        update operation_record
        set serial_number = #{serialNumber}
        where id = #{id}
    </update>

    <select id="queryAllOpersByTime" resultType="com.picto.entity.OperationRecord">
        <include refid="queryOperationRecordColumn" />
        where merchant_id = #{merchantId} and type = #{type} and operation_time &gt;= #{startTime} and operation_time &lt;= #{endTime}
    </select>
    
    <insert id="addOperationRecordCouponTypeRel" keyProperty="id" useGeneratedKeys="true" parameterType="com.picto.entity.OperationRecordCouponTypeRel">
        insert into operation_record_coupon_type_rel(operation_record_id, coupon_type_id)
        values(#{operationRecordId}, #{couponTypeId})
    </insert>
    
    <insert id="addOperationRecordCouponRel" keyProperty="id" useGeneratedKeys="true" parameterType="com.picto.entity.OperationRecordCouponRel">
        insert into operation_record_coupon_rel(operation_record_id, coupon_id)
        values(#{operationRecordId}, #{couponId})      
    </insert>
    
    <sql id="queryOrCtRelAllColumn">
        select id AS id,
        operation_record_id AS operationRecordId,
        coupon_type_id AS couponTypeId
        from operation_record_coupon_type_rel
    </sql>    
    
    <select id="queryOrCtRelByOrId" resultType="com.picto.entity.OperationRecordCouponTypeRel">
        <include refid="queryOrCtRelAllColumn" />
        where operation_record_id=#{orId}
    </select>
    
    <sql id="queryOrCRelAllColumn">
        select id AS id,
        operation_record_id AS operationRecordId,
        coupon_id AS couponId
        from operation_record_coupon_rel
    </sql>    
    
    <select id="queryOrCRelByOrId" resultType="com.picto.entity.OperationRecordCouponRel">
        <include refid="queryOrCRelAllColumn" />
        where operation_record_id=#{orId}
    </select>    
</mapper>